<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>Create and Manage Kubernetes Clusters with Cluster API and ArgoCD</title>
<!--

Template 2085 Neuron

http://www.tooplate.com/view/2085-neuron

-->
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/font-awesome.min.css">

<!-- Main css -->
<link rel="stylesheet" href="css/style.css">
<link href="https://fonts.googleapis.com/css?family=Lora|Merriweather:300,400" rel="stylesheet">

</head>
<body>

<!-- PRE LOADER -->

<div class="preloader">
     <div class="sk-spinner sk-spinner-wordpress">
          <span class="sk-inner-circle"></span>
     </div>
</div>

<!-- Navigation section  -->

<div class="navbar navbar-default navbar-static-top" role="navigation">
     <div class="container">

          <div class="navbar-header">
               <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon icon-bar"></span>
                    <span class="icon icon-bar"></span>
                    <span class="icon icon-bar"></span>
               </button>
               <a href="index.html" class="navbar-brand">Thi</a>
          </div>
          <div class="collapse navbar-collapse">
               <ul class="nav navbar-nav navbar-right">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="https://dinhdobathi.com">Thi's CV</a></li>
                    <li><a href="gallery.html">Gallery</a></li>
                    <li><a href="contact.html">Contact</a></li>
               </ul>
          </div>

  </div>
</div>

<!-- Home Section -->

<section id="home" class="main-single-post parallax-section">
     <div class="overlay"></div>
     <div class="container">
          <div class="row">

               <div class="col-md-12 col-sm-12">
                    <h1>Create and Manage Kubernetes Clusters with Cluster API and ArgoCD</h1>
               </div>

          </div>
     </div>
</section>

<!-- Blog Single Post Section -->

<section id="blog-single-post">
     <div class="container">
          <div class="row">

               <div class="col-md-offset-1 col-md-10 col-sm-12">
                    <div class="blog-single-post-thumb">
                         

                         <div class="blog-post-title">
                              <h2>Create and Manage Kubernetes Clusters with Cluster API and ArgoCD</a></h2>
                         </div>

                         <div class="blog-post-format">
                              <span><a href="#"><img src="images/author-image1.jpg" class="img-responsive img-circle"> Thi</a></span>
                              <span><i class="fa fa-date"></i> Sept 22, 2022</span>
                              <span><a href="#"><i class="fa fa-comment-o"></i> 0 Comments</a></span>
                         </div>
                         <blockquote>This article was from Mr <a href="https://piotrminkowski.com/2021/10/25/kubernetes-multicluster-with-kind-and-cilium/">"piotr.minkowski"</a>, All content was written by him </blockquote>
                         <div class="blog-post-des">
                             
                              
                              <div class="blog-post-image">
                              <img src="images/blog-image1.jpg" class="img-responsive" alt="Blog Image 3">
                         </div>
                         
                              <h3>Create and Manage Kubernetes Clusters with Cluster API and ArgoCD</h3>
                              <p>.</p>
                         </div>
                         
                         

                         <p>In this article, you will learn how to create and manage multiple Kubernetes clusters using Kubernetes Cluster API and ArgoCD. We will create a single, local cluster with Kind. On that cluster, we will provision the process of other Kubernetes clusters creation. In order to perform that process automatically, we will use ArgoCD. Thanks to it, we can handle the whole process from a single Git repository. Before we start, let’s do a theoretical brief.<span id="more-10285"></span></p>



                         <p>If you are interested in topics related to the Kubernetes multi-clustering you may also read some other articles about it:</p>
                         
                         
                         
                         <ol><li><a href="https://piotrminkowski.com/2021/10/25/kubernetes-multicluster-with-kind-and-cilium/">Kubernetes Multicluster with Kind and Cilium</a></li><li><a href="https://piotrminkowski.com/2021/07/12/multicluster-traffic-mirroring-with-istio-and-kind/">Multicluster Traffic Mirroring with Istio and Kind</a></li><li><a href="https://piotrminkowski.com/2021/07/08/kubernetes-multicluster-with-kind-and-submariner/">Kubernetes Multicluster with Kind and Submariner</a></li></ol>
                         
                         
                         
                         <p></p>
                         
                         
                         <h2 id="introduction-0f51ac21-4605-400c-b828-d298931d176f">Introduction</h2>



                         <p>Did you hear about a project called <a href="https://cluster-api.sigs.k8s.io/">Kubernetes Cluster API</a>? It provides declarative APIs and tools to simplify provisioning, upgrading, and managing multiple Kubernetes clusters. In fact, it is a very interesting concept. We are creating a single Kubernetes cluster that manages the lifecycle of other clusters. On this cluster, we are installing Cluster API. And then we are just defining new workload clusters, by creating Cluster API objects. Looks simple? And that’s what is.</p>
                         
                         
                         
                         <p>Cluster API provides a set of CRDs extending the Kubernetes API. Each of them represents a customization of a Kubernetes cluster installation. I will not get into the details. But, if you are interested you may read more about it <a href="https://cluster-api.sigs.k8s.io/user/concepts.html">here</a>. What’s is important for us, it provides a CLI that handles the lifecycle of a Cluster API management cluster. Also, it allows creating clusters on multiple infrastructures including AWS, GCP, or Azure. However, today we are going to run the whole infrastructure locally on Docker and Kind. It is also possible with Kubernetes Cluster API since it supports Docker.</p>
                         
                         
                         
                         <p>We will use Cluster API CLI just to initialize the management cluster and generate YAML templates. The whole process will be managed by the ArgoCD installed on the management cluster. Argo CD perfectly fits our scenario, since it supports multi-clusters. The instance installed on a single cluster can manage many other clusters that is able to connect with.</p>
                         
                         
                         
                         <p>Finally, the last tool used today – <a href="https://kind.sigs.k8s.io/">Kind</a>. Thanks to it, we can run multiple Kubernetes clusters on the same machine using Docker container nodes. Let’s take a look at the architecture of our solution described in this article.</p>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <h2 id="architecture-with-kubernetes-cluster-api-and-argocd-32c883be-cad1-47f1-82c6-23d6e3651d14">Architecture with Kubernetes Cluster API and ArgoCD</h2>
                         
                         
                         
                         <p>Here’s the picture with our architecture. The whole infrastructure is running locally on Docker. We install Kubernetes Cluster API and ArgoCD on the management cluster. Then, using both those tools we are creating new clusters with Kind. After that, we are going to apply some Kubernetes objects into the workload clusters (<code>c1</code>, <code>c2</code>) like <code>Namespace</code>, <code>ResourceQuota</code> or <code>RoleBinding</code>. Of course, the whole process is managed by the Argo CD instance and configuration is stored in the Git repository.</p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-10.24.47.png" alt="kubernetes-cluster-api-argocd-arch" class="wp-image-10289" width="687" height="457" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.24.47.png?resize=1024%2C681&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.24.47.png?resize=300%2C200&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.24.47.png?resize=768%2C511&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.24.47.png?resize=1536%2C1022&amp;ssl=1 1536w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.24.47.png?resize=272%2C182&amp;ssl=1 272w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.24.47.png?w=1692&amp;ssl=1 1692w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.24.47.png?w=1392&amp;ssl=1 1392w" sizes="(max-width: 687px) 100vw, 687px" data-recalc-dims="1"></figure></div>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <h2 id="source-code-8019714d-4fc4-4bfd-8b99-23eb1469cd67">Source Code</h2>
                         
                         
                         
                         <p>If you would like to try it by yourself, you may always take a look at my source code. In order to do that you need to clone my GitHub&nbsp;<a href="https://github.com/piomin/sample-kubernetes-cluster-api-argocd.git">repository</a>. After that, you should just follow my instructions. Let’s begin.</p>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <h2 id="create-management-cluster-with-kind-and-cluster-api-d71b741b-fea2-43f9-99da-bb9422331fdf">Create Management Cluster with Kind and Cluster API</h2>
                         
                         
                         
                         <p>In the first step, we are going to create a management cluster on Kind. You need to have Docker installed on your machine, <code>kubectl</code> and <code>kind</code> to do that exercise by yourself. Because we use Docker infrastructure to run Kubernetes workloads clusters, Kind must have an access to the Docker host. Here’s the definition of the Kind cluster. Let’s say the name of the file is <code>mgmt-cluster-config.yaml</code>:</p>
                         

<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">YAML</span>
<span class="token key atrule">kind: Cluster </span>
<span class="token key atrule">apiVersion:kind.x-k8s.io/v1alpha4 </span>
<span class="token key atrule">nodes</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
<span class="token key atrule">extraMounts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> /var/run/docker.sock
<span class="token key atrule">containerPath</span><span class="token punctuation">:</span> /var/run/docker.sock</code></pre>


<p></p>
                         
                         
                         
                         <p>Now, let’s just apply the configuration visible above when creating a new cluster with Kind:</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ kind create cluster --config mgmt-cluster-config.yaml --name mgmt</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>If everything goes fine you should see a similar output. After that, your Kubernetes context is automatically set to <code>kind-mgmt</code>.</p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-10.40.38.png" alt="" class="wp-image-10290" width="696" height="191" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.40.38.png?resize=1024%2C280&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.40.38.png?resize=300%2C82&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.40.38.png?resize=768%2C210&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.40.38.png?w=1456&amp;ssl=1 1456w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.40.38.png?w=1392&amp;ssl=1 1392w" sizes="(max-width: 696px) 100vw, 696px" data-recalc-dims="1"></figure></div>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Then, we need to initialize a management cluster. In other words, we have to install Cluster API on our Kind cluster. In order to do that, we first need to install Cluster API CLI on the local machine. On macOS, I can use the <code>brew install clusterctl</code> command. Once the <code>clusterctl</code> has been successfully installed I can run the following command:</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ clusterctl init --infrastructure <span class="token function">docker</span></code></pre>
                         
                         
                         
                         <p></p>
                         
                         
 
                         
                         
                         
                         <figure class="wp-block-image size-large"><img loading="lazy" width="696" height="180" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-10.47.55.png" alt="kubernetes-cluster-api-argocd-init-mgmt" class="wp-image-10291" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.47.55.png?resize=1024%2C265&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.47.55.png?resize=300%2C78&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.47.55.png?resize=768%2C198&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.47.55.png?resize=1536%2C397&amp;ssl=1 1536w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.47.55.png?w=1780&amp;ssl=1 1780w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.47.55.png?w=1392&amp;ssl=1 1392w" sizes="(max-width: 696px) 100vw, 696px" data-recalc-dims="1"></figure>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Once we successfully initialized a management cluster we may verify it. Let’s display e.g. a list of namespaces. There are five new namespaces created by the Cluster API.</p>
                         
                         
                         
<pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">kubectl get ns
NAME                                STATUS   AGE
capd-system                         Active   3m37s
capi-kubeadm-bootstrap-system       Active   3m42s
capi-kubeadm-control-plane-system   Active   3m40s
capi-system                         Active   3m44s
cert-manager                        Active   4m8s
default                             Active   12m
kube-node-lease                     Active   12m
kube-public                         Active   12m
kube-system                         Active   12m
local-path-storage                  Active   12m</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Also, let’s display a list of all pods. All the pods created inside new namespaces should be in a running state.</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ kubectl get pod -A</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>We can also display a list of installed CRDs. Anyway, the Kubernetes Cluster API is running on the management cluster and we can proceed to the further steps. </p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-10.56.04.png" alt="" class="wp-image-10292" width="588" height="361" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.56.04.png?resize=1024%2C629&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.56.04.png?resize=300%2C184&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.56.04.png?resize=768%2C472&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-10.56.04.png?w=1234&amp;ssl=1 1234w" sizes="(max-width: 588px) 100vw, 588px" data-recalc-dims="1"></figure></div>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <h2 id="install-argo-cd-on-the-management-kubernetes-cluster-aae737d3-076f-4071-a36e-c60800afcc07">Install Argo CD on the management Kubernetes cluster</h2>
                         
                         
                         
                         <p>I will install Argo CD in the <code>default</code> namespace. But you can as well create a namespace <code>argocd</code> and install it there (following Argo CD documentation).</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ kubectl apply -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Then, let’s just verify the installation:</p>
                         
                         
                         
<pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ kubectl get pod
NAME                                  READY   STATUS    RESTARTS   AGE
argocd-application-controller-0       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63s
argocd-dex-server-6dcf645b6b-6dlk9    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63s
argocd-redis-5b6967fdfc-vg5k6         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63s
argocd-repo-server-7598bf5999-96mh5   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63s
argocd-server-79f9bc9b44-d6c8q        <span class="token number">1</span>/1     Running   <span class="token number">0</span>          63s</code></pre>



<p></p>

                         
                         
                         <p>As you probably know, Argo CD provides a web UI for management. To access it on the local port (8080), I will run the <code>kubectl port-forward</code> command:</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ kubectl port-forward svc/argocd-server <span class="token number">8080</span>:80</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Now, the UI is available under <code>http://localhost:8080</code>. To login there you need to find a Kubernetes Secret  <code>argocd-initial-admin-secret</code> and decode the password. The username is <code>admin</code>. You can easily decode secrets using for example <a href="https://k8slens.dev/">Lens</a> – advanced Kubernetes IDE. For now, only just log in there. We will back to Argo CD UI later.</p>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <h2 id="create-kubernetes-cluster-with-cluster-api-and-argocd-594b0de2-77d0-446e-a906-775868cacf09">Create Kubernetes cluster with Cluster API and ArgoCD</h2>
                         
                         
                         
                         <p>We will use the <code>clusterctl</code> CLI to generate YAML manifests with a declaration of a new Kubernetes cluster. To do that we need to run the following command. It will generate and save the manifest into the <code>c1-clusterapi.yaml</code> file.</p>
                         
                         

<pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ clusterctl generate cluster c1 --flavor development <span class="token punctuation">\</span>
     --infrastructure <span class="token function">docker</span> <span class="token punctuation">\</span>
     --kubernetes-version v1.21.1 <span class="token punctuation">\</span>
     --control-plane-machine-count<span class="token operator">=</span><span class="token number">3</span> <span class="token punctuation">\</span>
     --worker-machine-count<span class="token operator">=</span><span class="token number">3</span> <span class="token punctuation">\</span>
     <span class="token operator">&gt;</span> c1-clusterapi.yaml</code></pre>

                         
                         
                         <p></p>
                         
                         
                         
                         <p>Our <code>c1</code> cluster consists of three master and three worker nodes. Following Cluster API documentation we would have to apply the generated manifests into the management cluster. However, we are going to use ArgoCD to automatically apply the Cluster API manifest stored in the Git repository to Kubernetes. So, let’s create a manifest with Cluster API objects in the Git repository. To simplify the process I will use Helm templates. Because there are two clusters to create we have to Argo CD applications that use the same template with parametrization. Ok, so here’s the Helm template based on the manifest generated in the previous step. You can find it in our sample Git repository under the path <code>/mgmt/templates/cluster-api-template.yaml</code>. </p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">clusterNetwork</span><span class="token punctuation">:</span>
<span class="token key atrule">pods</span><span class="token punctuation">:</span>
     <span class="token key atrule">cidrBlocks</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> 192.168.0.0/16
<span class="token key atrule">serviceDomain</span><span class="token punctuation">:</span> cluster.local
<span class="token key atrule">services</span><span class="token punctuation">:</span>
     <span class="token key atrule">cidrBlocks</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> 10.128.0.0/12
<span class="token key atrule">controlPlaneRef</span><span class="token punctuation">:</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> controlplane.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeadmControlPlane
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>control<span class="token punctuation">-</span>plane
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">infrastructureRef</span><span class="token punctuation">:</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> infrastructure.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DockerCluster
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> infrastructure.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DockerCluster
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> infrastructure.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DockerMachineTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>control<span class="token punctuation">-</span>plane
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">template</span><span class="token punctuation">:</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">extraMounts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">containerPath</span><span class="token punctuation">:</span> /var/run/docker.sock
     <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> /var/run/docker.sock
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> controlplane.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeadmControlPlane
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>control<span class="token punctuation">-</span>plane
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">kubeadmConfigSpec</span><span class="token punctuation">:</span>
<span class="token key atrule">clusterConfiguration</span><span class="token punctuation">:</span>
     <span class="token key atrule">apiServer</span><span class="token punctuation">:</span>
     <span class="token key atrule">certSANs</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> localhost
     <span class="token punctuation">-</span> 127.0.0.1
     <span class="token key atrule">controllerManager</span><span class="token punctuation">:</span>
     <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span>
     <span class="token key atrule">enable-hostpath-provisioner</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
<span class="token key atrule">initConfiguration</span><span class="token punctuation">:</span>
     <span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
     <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> /var/run/containerd/containerd.sock
     <span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
     <span class="token key atrule">cgroup-driver</span><span class="token punctuation">:</span> cgroupfs
     <span class="token key atrule">eviction-hard</span><span class="token punctuation">:</span> nodefs.available&lt;0%<span class="token punctuation">,</span>nodefs.inodesFree&lt;0%<span class="token punctuation">,</span>imagefs.available&lt;0%
<span class="token key atrule">joinConfiguration</span><span class="token punctuation">:</span>
     <span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
     <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> /var/run/containerd/containerd.sock
     <span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
     <span class="token key atrule">cgroup-driver</span><span class="token punctuation">:</span> cgroupfs
     <span class="token key atrule">eviction-hard</span><span class="token punctuation">:</span> nodefs.available&lt;0%<span class="token punctuation">,</span>nodefs.inodesFree&lt;0%<span class="token punctuation">,</span>imagefs.available&lt;0%
<span class="token key atrule">machineTemplate</span><span class="token punctuation">:</span>
<span class="token key atrule">infrastructureRef</span><span class="token punctuation">:</span>
     <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> infrastructure.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
     <span class="token key atrule">kind</span><span class="token punctuation">:</span> DockerMachineTemplate
     <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>control<span class="token punctuation">-</span>plane
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.masterNodes <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.version <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> infrastructure.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DockerMachineTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">template</span><span class="token punctuation">:</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> bootstrap.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeadmConfigTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">template</span><span class="token punctuation">:</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">joinConfiguration</span><span class="token punctuation">:</span>
     <span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
     <span class="token key atrule">kubeletExtraArgs</span><span class="token punctuation">:</span>
          <span class="token key atrule">cgroup-driver</span><span class="token punctuation">:</span> cgroupfs
          <span class="token key atrule">eviction-hard</span><span class="token punctuation">:</span> nodefs.available&lt;0%<span class="token punctuation">,</span>nodefs.inodesFree&lt;0%<span class="token punctuation">,</span>imagefs.available&lt;0%
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> MachineDeployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
<span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">clusterName</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.workerNodes <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">selector</span><span class="token punctuation">:</span>
<span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token null important">null</span>
<span class="token key atrule">template</span><span class="token punctuation">:</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">bootstrap</span><span class="token punctuation">:</span>
     <span class="token key atrule">configRef</span><span class="token punctuation">:</span>
     <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> bootstrap.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
     <span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeadmConfigTemplate
     <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
     <span class="token key atrule">clusterName</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span>
     <span class="token key atrule">infrastructureRef</span><span class="token punctuation">:</span>
     <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> infrastructure.cluster.x<span class="token punctuation">-</span>k8s.io/v1beta1
     <span class="token key atrule">kind</span><span class="token punctuation">:</span> DockerMachineTemplate
     <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>md<span class="token punctuation">-</span><span class="token number">0</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
     <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.cluster.version <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>We can parameterize four properties related to cluster creation: name of the cluster, number of master and worker nodes, or a version of Kubernetes. Since we use Helm for that, we just need to create the <code>values.yaml</code> file containing values of those parameters in YAML format. Here’s the <code>values.yaml</code> file for the first cluster. You can find it in the sample Git repository under the path <code>/mgmt/values-c1.yaml</code>.</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">cluster</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> c1
     <span class="token key atrule">masterNodes</span><span class="token punctuation">:</span> <span class="token number">3</span>
     <span class="token key atrule">workerNodes</span><span class="token punctuation">:</span> <span class="token number">3</span>
     <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.21.1</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Here’s the same configuration for the second cluster. As you see, there is a single master node and a single worker node. You can find it in the sample Git repository under the path <code>/mgmt/values-c2.yaml</code>.</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">cluster</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> c2
     <span class="token key atrule">masterNodes</span><span class="token punctuation">:</span> <span class="token number">1</span>
     <span class="token key atrule">workerNodes</span><span class="token punctuation">:</span> <span class="token number">1</span>
     <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.21.1</code></pre>

                         
                         
                         <p></p>
                         
                         
                         
                         <h2>Create Argo CD applications</h2>
                         
                         
                         
                         <p>Since Argo CD supports Helm, we just need to set the right <code>values.yaml</code> file in the configuration of the ArgoCD application. Except that, we also need to set the address of our Git configuration repository and the directory with manifests inside the repository. All the configuration for the management cluster is stored inside the <code>mgmt</code> directory.</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Application
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> c1<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>create
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">destination</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">''</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">''</span>
     <span class="token key atrule">server</span><span class="token punctuation">:</span> <span class="token string">'https://kubernetes.default.svc'</span>
     <span class="token key atrule">source</span><span class="token punctuation">:</span>
     <span class="token key atrule">path</span><span class="token punctuation">:</span> mgmt
     <span class="token key atrule">repoURL</span><span class="token punctuation">:</span> <span class="token string">'https://github.com/piomin/sample-kubernetes-cluster-api-argocd.git'</span>
     <span class="token key atrule">targetRevision</span><span class="token punctuation">:</span> HEAD
     <span class="token key atrule">helm</span><span class="token punctuation">:</span>
          <span class="token key atrule">valueFiles</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> values<span class="token punctuation">-</span>c1.yaml
     <span class="token key atrule">project</span><span class="token punctuation">:</span> default</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Here’s a similar declaration for the second cluster:</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">&lt;meta charset="utf-8"&gt;apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Application
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> c2<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>create
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">destination</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">''</span>
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">''</span>
     <span class="token key atrule">server</span><span class="token punctuation">:</span> <span class="token string">'https://kubernetes.default.svc'</span>
     <span class="token key atrule">source</span><span class="token punctuation">:</span>
     <span class="token key atrule">path</span><span class="token punctuation">:</span> mgmt
     <span class="token key atrule">repoURL</span><span class="token punctuation">:</span> <span class="token string">'https://github.com/piomin/sample-kubernetes-cluster-api-argocd.git'</span>
     <span class="token key atrule">targetRevision</span><span class="token punctuation">:</span> HEAD
     <span class="token key atrule">helm</span><span class="token punctuation">:</span>
          <span class="token key atrule">valueFiles</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> values<span class="token punctuation">-</span>c2.yaml
     <span class="token key atrule">project</span><span class="token punctuation">:</span> default</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Argo CD requires privileges to manage Cluster API objects. Just to simplify, let’s add the <code>cluster-admin</code> role to the <code>argocd-application-controller</code> <code>ServiceAccount</code> used by Argo CD.</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin<span class="token punctuation">-</span>argocd<span class="token punctuation">-</span>contoller
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
     <span class="token key atrule">name</span><span class="token punctuation">:</span> argocd<span class="token punctuation">-</span>application<span class="token punctuation">-</span>controller
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
     <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
     <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
     <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>After creating applications in Argo CD you may synchronize them manually (or enable the auto-sync option). It begins the process of creating workload clusters by the Cluster API tool.</p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-12.38.44.png" alt="kubernetes-cluster-api-argocd-ui" class="wp-image-10304" width="682" height="307" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.38.44.png?resize=1024%2C462&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.38.44.png?resize=300%2C135&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.38.44.png?resize=768%2C346&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.38.44.png?resize=1536%2C693&amp;ssl=1 1536w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.38.44.png?w=1894&amp;ssl=1 1894w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.38.44.png?w=1392&amp;ssl=1 1392w" sizes="(max-width: 682px) 100vw, 682px" data-recalc-dims="1"></figure></div>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <h2 id="verify-kubernetes-clusters-using-cluster-api-cli-23d83744-3ed0-43b8-9120-09c0b2487f61">Verify Kubernetes clusters using Cluster API CLI</h2>
                         
                         
                         
                         <p>After performing synchronization with Argo CD we can verify a list of available Kubernetes clusters. To do that just use the following <code>kind</code> command:</p>
                         
                         
                         
<pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ kind get clusters
c1
c2
mgmt</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>As you see there are three running clusters! Kubernetes Cluster API installed on the management cluster has created two other clusters based on the configuration applied by Argo CD. To check if everything goes fine we may use the <code>clusterctl describe</code> command. After executing this command you would probably have a similar result to the visible below.</p>
                         
                         
                         
                         <figure class="wp-block-image size-large"><img loading="lazy" width="696" height="73" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-12.42.29.png" alt="" class="wp-image-10294" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.42.29.png?resize=1024%2C108&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.42.29.png?resize=300%2C32&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.42.29.png?resize=768%2C81&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.42.29.png?resize=1536%2C162&amp;ssl=1 1536w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.42.29.png?resize=2048%2C216&amp;ssl=1 2048w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.42.29.png?w=1392&amp;ssl=1 1392w" sizes="(max-width: 696px) 100vw, 696px" data-recalc-dims="1"></figure>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>The control plane is not ready. It is described in the Cluster API documentation. We need to install a CNI provider on our workload clusters in the next step. Cluster API documentation suggests installing Calico as the CNI plugin. We will do it, but before we need to switch to the <code>kind-c1</code> and <code>kind-c2</code> contexts. Of course, they were not created on our local machine by the Cluster API, so first we need to export them to our <code>Kubeconfig</code> file. Let’s do that for both workload clusters.</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml">$ kind export kubeconfig <span class="token punctuation">-</span><span class="token punctuation">-</span>name c1
$ kind export kubeconfig <span class="token punctuation">-</span><span class="token punctuation">-</span>name c2</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>I’m not sure why, but it exports contexts with <code>0.0.0.0</code> as the address of clusters. So in the next step, I also had to edit my <code>Kubeconfig</code> file and change this address to <code>127.0.0.1</code> as shown below. Now, I can connect both clusters using <code>kubectl</code> from my local machine.</p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-full is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-13.12.52.png" alt="" class="wp-image-10295" width="343" height="175" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.12.52.png?w=668&amp;ssl=1 668w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.12.52.png?resize=300%2C154&amp;ssl=1 300w" sizes="(max-width: 343px) 100vw, 343px" data-recalc-dims="1"></figure></div>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>And install Calico CNI on both clusters.</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ kubectl apply -f https://docs.projectcalico.org/v3.20/manifests/calico.yaml --context kind-c1
                         $ kubectl apply -f https://docs.projectcalico.org/v3.20/manifests/calico.yaml --context kind-c2</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>I could also automate that step in Argo CD. But for now, I just want to finish the installation. In the next section, I’m going to describe how to manage both these clusters using Argo CD running on the management cluster. Now, if you verify the status of both clusters using the <code>clusterctl describe command, it looks</code> perfectly fine.</p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-12.39.26.png" alt="kubernetes-cluster-api-argocd-cli" class="wp-image-10296" width="597" height="125" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.39.26.png?resize=1024%2C215&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.39.26.png?resize=300%2C63&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.39.26.png?resize=768%2C161&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-12.39.26.png?w=1212&amp;ssl=1 1212w" sizes="(max-width: 597px) 100vw, 597px" data-recalc-dims="1"></figure></div>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <h2 id="managing-workload-clusters-with-argocd-1f82d254-34be-4fec-88c4-0850516cf7ab">Managing workload clusters with ArgoCD</h2>
                         
                         
                         
                         <p>In the previous section, we have successfully created two Kubernetes clusters using the Cluster API tool and ArgoCD. To clarify, all the Kubernetes objects required to perform that operation were created on the management cluster. Now, we would like to apply a simple configuration visible below to our both workload clusters. Of course, we will also use the same instance of Argo CD for it.</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> demo
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quota
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">hard</span><span class="token punctuation">:</span>
     <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token string">'10'</span>
     <span class="token key atrule">requests.cpu</span><span class="token punctuation">:</span> <span class="token string">'1'</span>
     <span class="token key atrule">requests.memory</span><span class="token punctuation">:</span> 1Gi
     <span class="token key atrule">limits.cpu</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
     <span class="token key atrule">limits.memory</span><span class="token punctuation">:</span> 4Gi
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>limitrange
     <span class="token key atrule">namespace</span><span class="token punctuation">:</span> demo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">limits</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">default</span><span class="token punctuation">:</span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m
          <span class="token key atrule">defaultRequest</span><span class="token punctuation">:</span>
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> 128Mi
          <span class="token key atrule">type</span><span class="token punctuation">:</span> Container</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Unfortunately, there is no built-in integration between ArgoCD and the Kubernetes Cluster API tool. Although Cluster API creates a secret containing the <code>Kubeconfig</code> file per each created cluster, Argo CD is not able to recognize it to automatically add such a cluster to the managed clusters. If you are interested in more details, there is an interesting discussion about it <a href="https://github.com/argoproj/argo-cd/issues/4651">here</a>. Anyway, the goal, for now, is to add both our workload clusters to the list of clusters managed by the global instance of Argo CD running on the management cluster. To do that, we first need to log in to Argo CD. We need to use the same credentials and URL used to interact with web UI.</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ argocd login localhost:8080</code></pre>
                         
                         
                         
                         <p>Now, we just need to run the following commands, assuming we have already exported both Kubernetes contexts to our local <code>Kubeconfig</code> file:</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ argocd cluster <span class="token function">add</span> kind-c1
                         $ argocd cluster <span class="token function">add</span> kind-c2</code></pre>
                         
                         
                         
                         <p>If you run Docker on macOS or Windows it is not such a simple thing to do. You need to use an internal Docker address of your cluster. Cluster API creates secrets containing the <code>Kubeconfig</code> file for all created clusters. We can use it to verify the internal address of our Kubernetes API. Here’s a list of secrets for our workload clusters:</p>
                         
                         
                         
                         <pre class="wp-block-code language-bash" tabindex="0"><code lang="bash" class="language-bash">$ kubectl get secrets <span class="token operator">|</span> <span class="token function">grep</span> kubeconfig
                         c1-kubeconfig                               cluster.x-k8s.io/secret               <span class="token number">1</span>      85m
                         c2-kubeconfig                               cluster.x-k8s.io/secret               <span class="token number">1</span>      57m</code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>We can obtain the internal address after decoding a particular secret. For example, the internal address of my <code>c1</code> cluster is <code>172.20.0.3</code>.</p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-full is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-15.30.03.png" alt="" class="wp-image-10298" width="408" height="279" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-15.30.03.png?w=780&amp;ssl=1 780w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-15.30.03.png?resize=300%2C205&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-15.30.03.png?resize=768%2C524&amp;ssl=1 768w" sizes="(max-width: 408px) 100vw, 408px" data-recalc-dims="1"></figure></div>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Under the hood, Argo CD creates a secret related to each of managed clusters. It is recognized basing on the label name and value: <code>argocd.argoproj.io/secret-type: cluster</code>.</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> c1<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>secret
     <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">argocd.argoproj.io/secret-type</span><span class="token punctuation">:</span> cluster
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> c1
     <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//172.20.0.3<span class="token punctuation">:</span><span class="token number">6443</span>
     <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
     {
          "tlsClientConfig": {
          "insecure": false,
          "caData": "&lt;base64 encoded certificate&gt;",
          "certData": "&lt;base64 encoded certificate&gt;",
          "keyData": "&lt;base64 encoded key&gt;"
          }
     }</span></code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>If you added all your clusters successfully, you should see the following list in the <em>Clusters</em> section on your Argo CD instance.</p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-13.56.14.png" alt="" class="wp-image-10299" width="663" height="158" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.56.14.png?resize=1024%2C244&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.56.14.png?resize=300%2C72&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.56.14.png?resize=768%2C183&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.56.14.png?resize=1536%2C366&amp;ssl=1 1536w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.56.14.png?w=1652&amp;ssl=1 1652w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.56.14.png?w=1392&amp;ssl=1 1392w" sizes="(max-width: 663px) 100vw, 663px" data-recalc-dims="1"></figure></div>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <h2>Create Argo CD application for workload clusters</h2>
                         
                         
                         
                         <p>Finally, let’s create Argo CD applications for managing configuration on both workload clusters.</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">&lt;meta charset="utf-8"&gt;apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Application
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> c1<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">project</span><span class="token punctuation">:</span> default
     <span class="token key atrule">source</span><span class="token punctuation">:</span>
     <span class="token key atrule">repoURL</span><span class="token punctuation">:</span> <span class="token string">'https://github.com/piomin/sample-kubernetes-cluster-api-argocd.git'</span>
     <span class="token key atrule">path</span><span class="token punctuation">:</span> workload
     <span class="token key atrule">targetRevision</span><span class="token punctuation">:</span> HEAD
     <span class="token key atrule">destination</span><span class="token punctuation">:</span>
     <span class="token key atrule">server</span><span class="token punctuation">:</span> <span class="token string">'https://172.20.0.3:6443'</span></code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>And similarly to apply the configuration on the second cluster:</p>
                         
                         
                         
<pre class="wp-block-code language-yaml" tabindex="0"><code lang="yaml" class="language-yaml"><span class="token key atrule">&lt;meta charset="utf-8"&gt;apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Application
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> c2<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>config
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
     <span class="token key atrule">project</span><span class="token punctuation">:</span> default
     <span class="token key atrule">source</span><span class="token punctuation">:</span>
     <span class="token key atrule">repoURL</span><span class="token punctuation">:</span> <span class="token string">'https://github.com/piomin/sample-kubernetes-cluster-api-argocd.git'</span>
     <span class="token key atrule">path</span><span class="token punctuation">:</span> workload
     <span class="token key atrule">targetRevision</span><span class="token punctuation">:</span> HEAD
     <span class="token key atrule">destination</span><span class="token punctuation">:</span>
     <span class="token key atrule">server</span><span class="token punctuation">:</span> <span class="token string">'https://172.20.0.10:6443'</span></code></pre>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>Once you created both applications on Argo CD you synchronize them.</p>
                         
                         
                         
                         <figure class="wp-block-image size-large"><img loading="lazy" width="696" height="424" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-13.57.51.png" alt="" class="wp-image-10300" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.57.51.png?resize=1024%2C624&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.57.51.png?resize=300%2C183&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.57.51.png?resize=768%2C468&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.57.51.png?resize=1536%2C936&amp;ssl=1 1536w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.57.51.png?resize=2048%2C1248&amp;ssl=1 2048w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-13.57.51.png?w=1392&amp;ssl=1 1392w" sizes="(max-width: 696px) 100vw, 696px" data-recalc-dims="1"></figure>
                         
                         
                         
                         <p></p>
                         
                         
                         
                         <p>And finally, let’s verify that configuration has been successfully applied to the target clusters.</p>
                         
                         
                         
                         <div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img loading="lazy" src="./Create and Manage Kubernetes Clusters with Cluster API and ArgoCD_files/Screenshot-2021-12-03-at-14.15.32.png" alt="" class="wp-image-10301" width="465" height="224" srcset="https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-14.15.32.png?resize=1024%2C493&amp;ssl=1 1024w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-14.15.32.png?resize=300%2C145&amp;ssl=1 300w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-14.15.32.png?resize=768%2C370&amp;ssl=1 768w, https://i0.wp.com/piotrminkowski.com/wp-content/uploads/2021/12/Screenshot-2021-12-03-at-14.15.32.png?w=1050&amp;ssl=1 1050w" sizes="(max-width: 465px) 100vw, 465px" data-recalc-dims="1"></figure></div>
                         
                         
          </div>
     </div>
</section>

<!-- Footer Section -->

<footer>
     <div class="container">
          <div class="row">

               <div class="col-md-5 col-md-offset-1 col-sm-6">
                    <h3>Thi's Blog</h3>
                    <p>Some of content I will made a copy from other one, and some of others generated by me.</p>
                    <div class="footer-copyright">
                         <p>Copyright &copy; 2017 DinhDoBaThi</p>
                    </div>
               </div>

               <div class="col-md-4 col-md-offset-1 col-sm-6">
                    <h3>Talk to us</h3>
                    <p><i class="fa fa-globe"></i> District 7, HCMC</p>
                    <p><i class="fa fa-phone"></i> 077xxx9219992</p>
                    <p><i class="fa fa-save"></i> info@dinhdobathi.com</p>
               </div>

               <div class="clearfix col-md-12 col-sm-12">
                    <hr>
               </div>

               <div class="col-md-12 col-sm-12">
                    <ul class="social-icon">
                         <li><a href="#" class="fa fa-facebook"></a></li>
                         <li><a href="#" class="fa fa-twitter"></a></li>
                         <li><a href="#" class="fa fa-google-plus"></a></li>
                         <li><a href="#" class="fa fa-dribbble"></a></li>
                         <li><a href="#" class="fa fa-linkedin"></a></li>
                    </ul>
               </div>
               
          </div>
     </div>
</footer>
<!-- Back top -->
<a href="#back-top" class="go-top"><i class="fa fa-angle-up"></i></a>

<!-- SCRIPTS -->

<script src="js/jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.parallax.js"></script>
<script src="js/custom.js"></script>

</body>
</html>